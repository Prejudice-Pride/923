<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>SGS åŸºç¡€ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Cesium 1.95 -->
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <!-- æå‰è®¾ç½® Cesium é™æ€èµ„æºåŸºå‡†è·¯å¾„ï¼Œç¡®ä¿ Workers èƒ½æ­£ç¡®åŠ è½½ -->
  <script>window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/';</script>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js" crossorigin="anonymous"></script>

  <!-- Cesium Widget Library (ç½—ç›˜å’Œå¯¼èˆªæ§ä»¶) -->
  <link href="css/cesium-widget.min.css" rel="stylesheet" />
  <script src="js/cesium-widget.min.js"></script>

  <!-- SGS å®˜æ–¹åº“ï¼ˆæœ¬åœ°ç›¸å¯¹è·¯å¾„ï¼Œä¿æŒä¸åŸé¡¹ç›®ä¸€è‡´ï¼‰ -->
  <script src="CesiumJS/SGSTerrainProvider.js"></script>
  <script src="CesiumJS/SGSProvider.v2.js"></script>

  <script>
    // ä¿®æ­£ SGSTerrainProvider è¯·æ±‚ï¼š
    // 1) æ¢å¤ä½¿ç”¨åº“é»˜è®¤çš„å¼§åº¦ bboxï¼ˆä¸å†åšåº¦åˆ¶æ¢ç®—ï¼‰
    // 2) å¯é€‰ï¼šåœ¨ WMS 1.3.0(lat,lon) ä¸ 1.1.1(lon,lat) ä¹‹é—´åˆ‡æ¢ï¼ˆä»…æ”¹å†™è½´åº/åè®®æ ‡è¯†ï¼Œä¸æ”¹æ•°å€¼å•ä½ï¼‰
    (function patchSgsGetRequestUrl(){
      try {
        if (window.SGSTerrainProvider && !window.__sgs_deg_bbox_patch) {
          const proto = SGSTerrainProvider.prototype;
          const reqFactor = function(self, level){
            const r = Math.log(self._requestGridSize)/Math.log(2);
            const k = Math.min(r, level);
            return Math.pow(2, k);
          };
          // è½´åºæ¨¡å¼
          window.__sgs_wms_axisMode = window.__sgs_wms_axisMode || 'wms111_lonlat';
          window.toggleSgsAxisMode = function(){
            window.__sgs_wms_axisMode = (window.__sgs_wms_axisMode === 'wms130_latlon') ? 'wms111_lonlat' : 'wms130_latlon';
            console.log('[SGS] å·²åˆ‡æ¢è½´åºæ¨¡å¼ =>', window.__sgs_wms_axisMode);
            try { location.reload(); } catch (_) {}
          };

          proto.getRequestUrl = function(x, y, level, optimizeFlag, asElevation){
            const factor = optimizeFlag != null ? reqFactor(this, level) : 1;
            const xx = optimizeFlag != null ? (x - (x % factor)) / factor : x;
            const yy = optimizeFlag != null ? (y - (y % factor)) / factor : y;
            const lvl = optimizeFlag != null ? level - Math.log(factor)/Math.log(2) : level;
            // æ³¨æ„ï¼šåº“æœ¬èº«ç”¨çš„æ˜¯å¼§åº¦ï¼Œè¿™é‡Œä¸åšåº¦åˆ¶æ¢ç®—
            const rect = this.tilingScheme.tileXYToNativeRectangle(xx, yy, lvl);
            let optimizedOnly = (this.heightMapWidth * factor == 256 && optimizeFlag) ? 1 : 0;
            if (asElevation) optimizedOnly = 0;
            const south = rect.south;
            const west  = rect.west;
            const north = rect.north;
            const east  = rect.east;
            let url = this._urlTemplate
              .replace("{optimizedOnly}", optimizedOnly)
              .replace("{width}", this.heightMapWidth * factor)
              .replace("{height}", this.heightMapHeight * factor)
              .replace("{s}", this.sTag(xx, yy, lvl));

            if (window.__sgs_wms_axisMode === 'wms111_lonlat') {
              // 1.1.1 + SRSï¼Œbbox=west,south,east,northï¼ˆlon,latï¼‰
              url = url
                .replace('Version=1.3.0', 'Version=1.1.1')
                .replace('CRS=EPSG:4326', 'SRS=EPSG:4326')
                .replace('{south},{west},{north},{east}', '{west},{south},{east},{north}')
                .replace('{west}', west)
                .replace('{south}', south)
                .replace('{east}', east)
                .replace('{north}', north);
            } else {
              // 1.3.0 + CRSï¼Œbbox=south,west,north,eastï¼ˆlat,lonï¼‰
              url = url
                .replace('{south}', south)
                .replace('{north}', north)
                .replace('{west}', west)
                .replace('{east}', east);
            }

            url += "&level=" + lvl + "&origLevel=" + level;
            if (!this.__loggedOnce) { console.log('[SGS] ç¤ºä¾‹åœ°å½¢URL', url); this.__loggedOnce = true; }
            return url;
          };
          window.__sgs_deg_bbox_patch = true;
          console.log('[SGS] ä½¿ç”¨å¼§åº¦bboxï¼Œè½´åºæ¨¡å¼=', window.__sgs_wms_axisMode);
        }
      } catch (err) {
        console.warn('æœªèƒ½åº”ç”¨ SGSTerrainProvider è¡¥ä¸', err);
      }
    })();

    // SGS æœåŠ¡å™¨åœ°å€
    window.SGS_SERVER = "http://124.17.4.220:24088/SG";

    // å¸¸é‡å·²åœ¨ SGSProvider.v2.js ä¸­å®šä¹‰ï¼Œè¿™é‡Œåªæ˜¯ç¡®ä¿å…¨å±€å¯ç”¨
    window._ResourceType = _ResourceType;
    window._LayerType = _LayerType;
  </script>


  <link rel="stylesheet" href="css/main.css">
  <!-- åŠ è½½åŠ¨ç”»ç³»ç»Ÿæ ·å¼ -->
  <link rel="stylesheet" href="loading/loading.css">
  <!-- ç®€å•å·¥å…·æ æ ·å¼ -->
  <link rel="stylesheet" href="css/toolbar-refined.css">
  <link rel="stylesheet" href="css/tree-simple.css">
  <link rel="stylesheet" href="css/floating-toolbar.css">
  <!-- å¯¼èˆªæ§ä»¶ä½ç½®è°ƒæ•´ -->
  <link rel="stylesheet" href="css/navigation-position.css">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ§ä»¶ -->
  <link rel="stylesheet" href="css/custom-navigation.css">
</head>
<body>
  <!-- åŠ è½½åŠ¨ç”»é¡µé¢ -->
  <div class="loading-overlay" id="loadingOverlay">
    <!-- 3DåŠ¨ç”»å®¹å™¨ -->
    <div class="loading-animation-container">
      <div id="loading-canvas"></div>
    </div>

    <!-- åŠ è½½ä¿¡æ¯é¢æ¿ -->
    <div class="loading-info">
      <!-- åº”ç”¨æ ‡é¢˜ -->
      <div class="loading-title">ä¸‰ç»´åœ°å›¾å¯è§†åŒ–ç³»ç»Ÿ</div>

      <!-- åŠ è½½çŠ¶æ€æ–‡å­— -->
      <div class="loading-status" id="loadingStatus">
        åˆå§‹åŒ–åº”ç”¨<span class="loading-dots"></span>
      </div>

      <!-- è¿›åº¦æ¡å®¹å™¨ -->
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- è¿›åº¦ç™¾åˆ†æ¯” -->
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <!-- å³ä¸Šè§’æ°´å° -->
  <div class="watermark">2023YFC3007305-01</div>
  
  <!-- ä¸“ä¸šGISç•Œé¢ - ä»¿ç…§å‚è€ƒè®¾è®¡ -->

  <!-- å·¦ä¾§å·¥å…·æ å·²ç§»é™¤ - åŠŸèƒ½æ•´åˆåˆ°å³é”®èœå•å’Œå³ä¸Šè§’å·¥å…·é¢æ¿ -->

  <!-- å³ä¾§å¤šåŠŸèƒ½æ§åˆ¶é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼Œä¿ç•™å¤‡ç”¨ï¼‰ -->
  <div class="right-panel hidden" style="display: none;">
    <div class="panel-header">
      <span class="panel-title">æ§ä»¶</span>
      <button class="panel-close" onclick="toggleRightPanel()">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- ç•Œé¢æ§ä»¶ - ç´§å‡‘å‹ç½‘æ ¼ -->
      <div class="control-section">
        <div class="section-title">ç•Œé¢æ§ä»¶</div>
        <div class="control-grid-compact">
          <label class="ctrl-item">
            <input type="checkbox" id="cbHelp" checked>
            <span>å¸®åŠ©</span>
          </label>
          <label class="ctrl-item">
            <input type="checkbox" id="cbMapControl" checked>
            <span>ç¼©æ”¾</span>
          </label>
          <label class="ctrl-item">
            <input type="checkbox" id="cbStatusInfo" checked>
            <span>çŠ¶æ€æ </span>
          </label>
          <label class="ctrl-item">
            <input type="checkbox" id="cbNavBall" checked>
            <span>å¯¼èˆªçƒ</span>
          </label>
          <label class="ctrl-item">
            <input type="checkbox" id="cbCompareRule" checked>
            <span>æ¯”ä¾‹å°º</span>
          </label>
        </div>
      </div>

      <!-- å›¾å±‚ç®¡ç† - ç´§å‡‘å‹å¸ƒå±€ -->
      <div class="control-section">
        <div class="section-title">å›¾å±‚ç®¡ç†</div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸ”ï¸ åœ°å½¢</span>
            <input type="checkbox" id="terrainToggle" class="native-switch">
          </div>
          <div class="slider-row">
            <span class="slider-label">å¤¸å¼  <em id="lbExag">4.0Ã—</em></span>
            <input id="slExag" type="range" min="1" max="8" step="0.5" value="4" class="native-slider">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸ›°ï¸ å½±åƒ</span>
            <input type="checkbox" id="imageryToggle" checked class="native-switch">
          </div>
          <div class="slider-row">
            <span class="slider-label">é€æ˜ <em id="lbOpacity">100%</em></span>
            <input id="slOpacity" type="range" min="0" max="1" step="0.05" value="1" class="native-slider">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸŒ åœ°éœ‡</span>
            <input type="checkbox" id="earthquakeToggle" class="native-switch">
          </div>
          <div class="slider-row">
            <span class="slider-label">éœ‡çº§ M<em id="lbMinMag">3.0</em>+</span>
            <input id="slMinMagnitude" type="range" min="1" max="7" step="0.1" value="3.0" class="native-slider">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸ“¡ å°ç«™</span>
            <input type="checkbox" id="stationToggle" class="native-switch">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸ”´ æ–­å±‚</span>
            <input type="checkbox" id="faultToggle" class="native-switch">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸ—ºï¸ äº”ä»£å›¾</span>
            <input type="checkbox" id="generationToggle" class="native-switch">
          </div>
        </div>

        <div class="layer-compact">
          <div class="layer-row">
            <span class="layer-label">ğŸŒ è¡Œæ”¿ç•Œçº¿</span>
          </div>
          <div style="margin-left: 15px; margin-top: 5px;">
            <div class="layer-row" style="font-size: 12px;">
              <span class="layer-label">ğŸŒ å›½ç•Œ</span>
              <input type="checkbox" id="countryBoundaryToggle" class="native-switch">
            </div>
            <div class="layer-row" style="font-size: 12px;">
              <span class="layer-label">ğŸ—¾ çœç•Œ</span>
              <input type="checkbox" id="provinceBoundaryToggle" class="native-switch">
            </div>
            <div class="layer-row" style="font-size: 12px;">
              <span class="layer-label">ğŸ˜ï¸ å¸‚ç•Œ</span>
              <input type="checkbox" id="cityBoundaryToggle" class="native-switch">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- çŠ¶æ€æ  - ç²¾ç®€ç‰ˆ -->
  <div class="bottombar" id="bottombar">
    <div class="status-group">
      <span class="status-item" id="posLLBox"><span class="status-value coord" id="posLL">103.10344Â°, 24.12504Â°</span></span>
      <span class="status-item">é«˜ç¨‹: <span class="status-value elevation" id="posH">5588</span>m</span>
      <span class="status-item">è§†é«˜: <span class="status-value camera-height" id="camH">19808</span>m</span>
    </div>

    <div style="flex: 1;"></div>

    <div class="status-group">
      <span class="status-item">æ¸²æŸ“: <span class="status-value">WebGL 2.0</span></span>
      <span class="status-item">ç‰ˆæœ¬: <span class="status-value">Cesium 1.95</span></span>
    </div>
  </div>

  <!-- åŠ è½½åŠ¨ç”»ç³»ç»Ÿ -->
  <script src="loading/loading-manager.js"></script>
  <script src="loading/loading.js"></script>


  <!-- æ¨¡å—åŒ–JavaScriptæ–‡ä»¶å¼•ç”¨ -->
  <script src="js/sgs-manager.js"></script>
  <script src="js/map-controls.js"></script>
  <script src="js/ui-controls.js"></script>
  <script src="js/measure-tools.js"></script>
  <script src="js/earthquake-layer.js"></script>
  <script src="js/station-layer.js"></script>
  <script src="js/fault-layer.js"></script>
  <script src="js/generation-layer.js"></script>
  <script src="js/country-boundary-layer.js"></script>
  <script src="js/province-boundary-layer.js"></script>
  <script src="js/city-boundary-layer.js"></script>
  <script src="js/boundary-manager.js"></script>
  <script src="js/research-area-layer.js"></script>
  <script src="js/context-menu.js"></script>
  <!-- 3Då›¾å±‚æ ‘ç®¡ç†å™¨ -->
  <script src="js/3d-layer-tree-manager.js"></script>
  <!-- 3Då·¥å…·æ ç»„ä»¶ -->
  <script src="js/3d-toolbar.js"></script>
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ§ä»¶ -->
  <script src="js/custom-navigation.js"></script>
  <!-- è·ç¦»æ¯”ä¾‹å°º -->
  <script src="js/distance-legend.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
