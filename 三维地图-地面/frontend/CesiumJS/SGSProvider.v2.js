var _URL,SGSProvider={};let _Errors={CONNECTION_ERROR:"Cannot connect to SGS",URL_NOT_VALID:"URL is not valid",URL_NOT_DEFINED:"URL is not defined. Connect to SGS first",PROJECT_NOT_DEFINED:"The project parameter is undefined",RESOURCE_NOT_DEFINED:"The resource parameter is undefined",FAIL_TO_GET_BBOX:"Cannot retrieve bbox information"},_LayerType={MESH:1,POINT_CLOUD:2,IMAGERY:4,ELEVATION:8},_ResourceType={ID_OR_ALIAS:1,TAG:2};SGSProvider.connect=function(e,r,t){viewer.scene.sl_addedObjects||(viewer.scene.sl_addedObjects=[]),viewer.terrainProvider._allElevationLayers||(viewer.terrainProvider._allElevationLayers=[]);e=_ParseURL(e);return _Connect2SG(e,r,t)},SGSProvider.loadLayersFromProject=function(e,r){if(!_URL)throw new Error(_Errors.URL_NOT_DEFINED);if(!e)throw new Error(_Errors.PROJECT_NOT_DEFINED);_LoadLayersFromProject(e,r)},SGSProvider.loadLayers=function(e,r,t){if(!_URL)throw new Error(_Errors.URL_NOT_DEFINED);if(!e)throw new Error(_Errors.RESOURCE_NOT_DEFINED);(r=r||_ResourceType.ID_OR_ALIAS)!=_ResourceType.ID_OR_ALIAS&&r!=_ResourceType.TAG||_LoadLayersByResource(e,r,t)},SGSProvider.requestVertexNormals=!1;var _ParseURL=function(e){if(!e)throw new Error(_Errors.URL_NOT_VALID);var r=e.match(/^\s*(http|https):\/\/([^\/\:]+)(\:\d+)?/i);if(null==r)throw new Error(_Errors.URL_NOT_VALID);return{url:e.trim(),protocol:r[1],domain:r[2],port:r[3]||("http"==r[1]?80:443)}},_Connect2SG=function(a,o,s){return new Promise((r,t)=>{var e={request:"login",sgClientData:localStorage.sgClientData},e=(o&&(e.username=o,e.password=s),null!=localStorage.sgClientData&&localStorage.removeItem("sgClientData"),JSON.stringify(e)),n=new XMLHttpRequest;n.onreadystatechange=function(){var e;4===n.readyState&&(200===n.status?"success"==(e=JSON.parse(n.responseText)).result?(Cesium.TrustedServers.add(a.domain,a.port),_URL=a.url,r()):t(e.resultMessageDescription):t(_Errors.CONNECTION_ERROR))},n.withCredentials=!0,n.open("POST",_BuildUrl(a.url,"ConnectSG")),n.send(e)})},_BuildUrl=function(e,r,t){if(!e)throw new Error(_Errors.URL_NOT_DEFINED);if(!r)return e;e=e.match(/^([^\?]+)(.*)/i);if(null==e)throw new Error(_Errors.URL_NOT_DEFINED);r=e[1].replace(/[\/]+$/,"")+"/"+r.replace(/^[\/]+/,"")+e[2];return t&&Array.isArray(t)&&0<t.length&&(-1<r.indexOf("?")?r+="&":r+="?",r+=t.join("&")),r},_LoadLayersFromProject=function(e,t){var e=_BuildUrl(_URL,"/projects/"+e.toString(),["_="+(new Date).getTime().toString()]),n=new XMLHttpRequest;n.onreadystatechange=function(e){var r;4==n.readyState&&200<=n.status&&n.status<300&&null!=n.response&&(r=[],(!t||0==t.length||t===_LayerType.MESH||-1<t.indexOf(_LayerType.MESH))&&(r=_ParseMeshLayersFromKML(n.response),_AddToScene3D(r)),(!t||0==t.length||t===_LayerType.IMAGERY||-1<t.indexOf(_LayerType.IMAGERY))&&(r=_ParseWMSLayersFromProject(n.response,_LayerType.IMAGERY),_AddWMSLayersFromServer(r)),(!t||0==t.length||t===_LayerType.ELEVATION||-1<t.indexOf(_LayerType.ELEVATION))&&(r=_ParseWMSLayersFromProject(n.response,_LayerType.ELEVATION),_AddWMSLayersFromServer(r)),!t||0==t.length||t===_LayerType.POINT_CLOUD||-1<t.indexOf(_LayerType.POINT_CLOUD))&&(r=_ParsePointCloudLayersFromKML(n.response),_AddToScene3D(r))},n.withCredentials=!0,n.open("GET",e),n.send()},_LoadLayersByResource=function(e,r,i){var r=_FindKeyByValue(_ResourceType,r),t=[],e=(t.push("resourceId="+e.toString()),r&&t.push("resourceType="+r),_BuildUrl(_URL,"/query",t)),l=new XMLHttpRequest;l.onreadystatechange=function(e){if(4==l.readyState&&200<=l.status&&l.status<300&&null!=l.response){for(var r=[],t=[],n=JSON.parse(l.response),a=0;a<n.length;a++){var o=n[a],s=o.type.toLocaleLowerCase();"mesh3dml"==s&&(!i||0==i.length||i===_LayerType.MESH||Array.isArray(i)&&-1<i.indexOf(_LayerType.MESH))&&r.push({name:o.name,url:_BuildUrl(_URL,"/b3dm/"+o.name+"/tileset.json")}),"imagery"!=s&&"rastercomplex"!=s||(!i||0==i.length||i===_LayerType.IMAGERY||Array.isArray(i)&&-1<i.indexOf(_LayerType.IMAGERY))&&t.push({name:o.name,url:void 0,isElevation:!1,sourceExtension:o.sourceExtension}),"elevation"!=s&&"rastercomplex"!=s||(!i||0==i.length||i===_LayerType.ELEVATION||Array.isArray(i)&&-1<i.indexOf(_LayerType.ELEVATION))&&t.push({name:o.name,url:void 0,isElevation:!0,sourceExtension:o.sourceExtension}),"pointcloud"==s&&(!i||0==i.length||i===_LayerType.POINT_CLOUD||Array.isArray(i)&&-1<i.indexOf(_LayerType.POINT_CLOUD))&&r.push({name:o.name,url:_BuildUrl(_URL,"/pnts/"+o.name+"/tileset.json")})}_AddToScene3D(r),_AddWMSLayersFromServer(t)}},l.withCredentials=!0,l.open("GET",e),l.send()},_ParseWMSLayersFromProject=function(e,r){for(var t=(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("sx\\:RasterLayer, RasterLayer"),n=0<(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("sx\\:accessToken,accessToken").length,a=[],o=0;o<t.length;o++){var s={fromKML:!0},i=t[o],l=void 0,u=i.querySelectorAll("sx\\:accessToken,accessToken"),u=(0<u.length&&(l=u[0].textContent),s.isMapbox=l,s.url=i.querySelector("Link href").textContent,s.name=i.querySelector("Link sx\\:layerName,Link layerName,sx\\:RasterLayer name,RasterLayer name").textContent,i.querySelector("sx\\:elevation,elevation"));s.isElevation=!!u&&"1"==u.textContent,r==_LayerType.ELEVATION&&!s.isElevation||r==_LayerType.IMAGERY&&s.isElevation||!s.isElevation&&n&&!l||a.push(s)}return a},_ParsePointCloudLayersFromKML=function(e){for(var r=(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("sx\\:PointCloud, PointCloud"),t=[],n=0;n<r.length;n++){var a={},o=r[n];a.name=o.querySelector("sx\\:name, name").textContent;var o=o.querySelector("href").textContent.trim().split("@");2==o.length&&(o=(-1<o[1].indexOf("$")?"https://":"http://")+o[1].replace(/[\$]+/g,"").replace(/\/+$/,"")+"/pnts/"+o[0].replace(/\.cpt$/i,"")+"/tileset.json",a.url=o,t.push(a))}return t},_ParseMeshLayersFromKML=function(e){for(var r=(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("sx\\:MeshLayer, MeshLayer"),t=[],n=0;n<r.length;n++){var a={},o=r[n];a.name=o.querySelector("sx\\:layerName, layerName").textContent;var o=(o=o.querySelector("href").textContent.trim()).replace(/\/+streamer[.]ashx/gi,"/b3dm"),s="";"json"!==Cesium.getExtensionFromUri(a.name)&&(s="/"),-1==o.toLocaleLowerCase().indexOf(a.name.toLocaleLowerCase())&&(o+="/"+a.name.trim()+s+"tileset.json"),a.url=o,t.push(a)}return t},_AddToScene3D=async function(e){Cesium.Cesium3DTileset.loadJson=function(a){var e=Cesium.Resource.createIfNeeded(a);return e.fetchJson().catch(function(){e.fetch().then(function(e){if(-1<e.indexOf("not authorized")){console.log(e);var r,e=viewer.scene.primitives._primitives.filter(function(e){return e._url===a._url});if(1===e.length){viewer.scene.primitives.remove(e[0]);for(var t=0;t<viewer.scene.sl_addedObjects.length;t++){var n=viewer.scene.sl_addedObjects[t];n instanceof Cesium.Cesium3DTileset&&n._url===a._url&&(r=t)}void 0!==r&&viewer.scene.sl_addedObjects.splice(r,1)}}})})};for(var r=e,t=0;t<r.length;t++){var n=r[t],a=await Cesium.Cesium3DTileset.fromUrl(n.url),a=viewer.scene.primitives.add(a);a.name=n.name,viewer.scene.sl_addedObjects.push(a)}},_ReadRasterBBOxFromServer=function(r){return new Promise((t,n)=>{r.isMapbox&&t(void 0);var a,e=r.url+"?SERVICE=WMS&REQUEST=GetCapabilities&layers="+r.name,o=new XMLHttpRequest;o.onreadystatechange=function(e){var r;4==o.readyState&&(200<=o.status&&o.status<300?(r=o.responseXML.getElementsByTagName("EX_GeographicBoundingBox"),a=0==r.length?0==(r=o.responseXML.getElementsByTagName("LatLonBoundingBox")).length?Cesium.Rectangle.MAX_VALUE:Cesium.Rectangle.fromDegrees(parseFloat(r[0].attributes.minx.value),parseFloat(r[0].attributes.miny.value),parseFloat(r[0].attributes.maxx.value),parseFloat(r[0].attributes.maxy.value)):Cesium.Rectangle.fromDegrees(parseFloat(r[0].getElementsByTagName("westBoundLongitude")[0].textContent),parseFloat(r[0].getElementsByTagName("southBoundLatitude")[0].textContent),parseFloat(r[0].getElementsByTagName("eastBoundLongitude")[0].textContent),parseFloat(r[0].getElementsByTagName("northBoundLatitude")[0].textContent)),t(a)):n(_Errors.FAIL_TO_GET_BBOX))},r.nonSGSItem||(o.withCredentials=!0),o.open("GET",e),o.send()})},_AddWMSLayersFromServer=function(e){for(var t=0;t<e.length;t++){let r=e[t];var n=r.isElevation?_BuildUrl(_URL,"/Elevation"):_BuildUrl(_URL,"/Imagery");r.fromKML||(r.url=n,r.sourceExtension&&(r.name+=r.sourceExtension.toLocaleLowerCase())),_ReadRasterBBOxFromServer(r).then(e=>{r.rectangle=e,_AddToScene2D(r)})}},_AddToScene2D=function(e){var r,t;e.isMapbox?r=new Cesium.MapboxImageryProvider({mapId:"mapbox.satellite",accessToken:e.isMapbox,url:"https://b.tiles.mapbox.com/v4",format:"jpeg"}):e.isElevation?viewer.terrainProvider=new SGSTerrainProvider({viewer:viewer,requestVertexNormals:SGSProvider.requestVertexNormals,url:e.url,layers:e.name}):r=new Cesium.WebMapServiceImageryProvider({url:e.url,layers:e.name,rectangle:e.rectangle,parameters:{transparent:"true",format:"image/png"}}),void 0!==(t=void 0!==r?viewer.imageryLayers.addImageryProvider(r):t)&&viewer.scene.sl_addedObjects.push(t)},_FindKeyByValue=function(e,r){var t=void 0,r=Object.values(e).indexOf(r);return t=-1<r?Object.keys(e)[r]:t},_SGSProviderLocation="";let _FindSGSProviderLocation=function(){var e=document.getElementsByTagName("script");return e[e.length-1].src.split("?")[0].split("/").slice(0,-1).join("/")+"/"};_SGSProviderLocation=_FindSGSProviderLocation();