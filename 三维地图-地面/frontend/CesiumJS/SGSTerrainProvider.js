var debugFlatTerrain=!1,SGSTerrainProvider=function(e){if(!Cesium.defined(e))throw new Cesium.DeveloperError("options is required.");this._errorEvent=new Cesium.Event,this._modelFloorMasks={},this._credit=e.credit,"string"==typeof this._credit&&(this._credit=new Cesium.Credit(this._credit)),e.heightMapWidth=Cesium.defaultValue(e.heightMapWidth,32),e.heightMapHeight=Cesium.defaultValue(e.heightMapHeight,32),this._options=e,this.readyPromise=Promise.resolve(!0),this._subdomains=e.subdomains,this._maxTerrainLevel=Cesium.defaultValue(e.maxTerrainLevel,30),this._useNotOptimized=e.useNotOptimized,e.firstRequestUrl=e.url.replace("{s}",this.sTag(0,0,0)),this._firstRequest=e.firstRequestUrl+"?request=GetMap&Version=1.3.0&Service=WMS&CRS=EPSG:4326&bbox=-90,-180,90,180&height=32&v=1&width=32&optimizedOnly=0&layers="+e.layers+"&Styles=&Format=image/mpt";var t,i=this;function a(e,r){e._isMPT=r,e._format=r?"mpt":"png"}void 0!==e.maxTerrainLevel&&isNaN(e.maxTerrainLevel)&&(e.maxTerrainLevel=void 0),this._maxTerrainLevel=Cesium.defaultValue(e.maxTerrainLevel,25),e.pngOnly?a(i,!1):((t=new XMLHttpRequest).onreadystatechange=function(e){if(4==t.readyState){if(!(200<=t.status&&t.status<300))return a(i,!1),null;var r=!!(Cesium.defined(t.responseXML)&&Cesium.defined(t.responseXML.childNodes)&&0<t.responseXML.childNodes.length);a(i,!r)}},t.withCredentials=!0,t.open("GET",this._firstRequest,!1),t.send()),this._urlTemplate=e.url+"?request=GetMap&Version=1.3.0&Service=WMS&v=1&CRS=EPSG:4326&bbox={south},{west},{north},{east}&height={height}&width={width}&optimizedOnly={optimizedOnly}&layers="+e.layers+"&Styles=&Format=image/"+this._format,this._allElevationLayers=null,this._tilingScheme=new Cesium.GeographicTilingScheme,this._levelZeroMaximumGeometricError=Cesium.TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid,4*e.heightMapWidth,this._tilingScheme.getNumberOfXTilesAtLevel(0)),this._workerPool=new WorkerPool({workerPath:SGSProvider?(_SGSProviderLocation||"")+"ParseElevationWorker.js":"../SGSTerrainProvider/ParseElevationWorker.js"}),this._pendingRequests=0,this._requestGridSize=8,this._requestsCache={},this._requestsCacheKeys=[],this.errorEvent.addEventListener(function(e){},this)};let TERRAIN_PLACEHOLDER=1;function getRandomIntInclusive(e,r){return Math.floor(Math.random()*(r-e+1))+e}SGSTerrainProvider._geometricErrorFactor=2,Object.defineProperties(SGSTerrainProvider.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){return this._credit}},hasVertexNormals:{get:function(){return!1}},tilingScheme:{get:function(){return this._tilingScheme}},ready:{get:function(){return!0}},hasWaterMask:{get:function(){return!1}},heightMapHeight:{get:function(){return this._options.heightMapHeight}},heightMapWidth:{get:function(){return this._options.heightMapWidth}},pendingRequests:{get:function(){return this._pendingRequests}}}),SGSTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)*SGSTerrainProvider._geometricErrorFactor},SGSTerrainProvider.prototype.createKeyFromTile=function(e,r,t){return e+"_"+r+"_"+t},SGSTerrainProvider.prototype.getTileDataAvailable=function(e,r,t){var i=Math.min(this._maxTerrainLevel,22);return this._isMPT?!this._useNotOptimized||void 0:t<i},SGSTerrainProvider.prototype.requestFactorForLevel=function(e){var r=Math.log(this._requestGridSize)/Math.log(2),r=Math.min(r,e);return Math.pow(2,r)},SGSTerrainProvider.prototype.getRequestBaseTerrainUrl=function(e,r,t,i){return this.getRequestUrl(e,r,t,i)},SGSTerrainProvider.prototype.getRequestElevationLayer=function(e,r,t){return this.getRequestUrl(e,r,t,!1,!0)},SGSTerrainProvider.prototype.getRequestUrl=function(e,r,t,i,a){var o=t,s=null!=i?this.requestFactorForLevel(t):1,e=null!=i?(e-e%s)/s:e,r=null!=i?(r-r%s)/s:r,t=null!=i?t-Math.log(s)/Math.log(2):t,n=this.tilingScheme.tileXYToNativeRectangle(e,r,t),i=this.heightMapWidth*s==256&&i?1:0;return a&&(i=0),this._urlTemplate.replace("{south}",n.south).replace("{north}",n.north).replace("{west}",n.west).replace("{east}",n.east).replace("{optimizedOnly}",i).replace("{width}",this.heightMapWidth*s).replace("{height}",this.heightMapHeight*s).replace("{s}",this.sTag(e,r,t))+"&level="+t+"&origLevel="+o},SGSTerrainProvider.prototype.isT_Inside_E=function(e,r){return e.west>=r.west*Cesium.Math.DEGREES_PER_RADIAN&&e.east<=r.east*Cesium.Math.DEGREES_PER_RADIAN&&e.south>=r.south*Cesium.Math.DEGREES_PER_RADIAN&&e.north<=r.north*Cesium.Math.DEGREES_PER_RADIAN},SGSTerrainProvider.prototype.isT_Intersects_E=function(e,r){var t=e.west*Cesium.Math.RADIANS_PER_DEGREE,i=e.east*Cesium.Math.RADIANS_PER_DEGREE,a=e.south*Cesium.Math.RADIANS_PER_DEGREE,e=e.north*Cesium.Math.RADIANS_PER_DEGREE,t=new Cesium.Rectangle(t,a,i,e);return Cesium.Rectangle.intersection(t,r,new Cesium.Rectangle)},SGSTerrainProvider.prototype.sTag=function(e,r,t){return null==this._subdomains?"":(e=(e+r+t)%this._subdomains.length,this._subdomains[e])},SGSTerrainProvider.prototype.refreshElevationLayer=function(e){e.rectangle&&void 0!==viewer.scene.globe._surface._levelZeroTiles&&this.findDirectParent(e.rectangle,!0).freeResources()},SGSTerrainProvider.prototype.findDirectParent=function(e,r){function s(e,r,t){if(e._rectangle.width<=r.width*(t?4.1:2.1)&&Cesium.Rectangle.contains(e._rectangle,Cesium.Rectangle.center(r)))return e;for(var i=e.children.length,a=0;a<i;a++){var o=e.children[a];if(Cesium.Rectangle.contains(o._rectangle,Cesium.Rectangle.center(r)))return s(o,r,t)}return null}if(e.width!=Math.PI)for(var t=0;t<viewer.scene.globe._surface._levelZeroTiles.length;t++){var i=s(viewer.scene.globe._surface._levelZeroTiles[t],e,r);if(i)return i}return null},SGSTerrainProvider.prototype.isTileAvailable=function(e,r,t){var i=this._tilingScheme.tileXYToRectangle(e,r,t,new Cesium.Rectangle),a=this.findDirectParent(i);if(a&&a.data&&a.data.terrainData){if(!(0<a.data.terrainData._childTileMask))return!1;for(var o=a.children.length,s=0;s<o;s++){var n=a.children[s];if(Cesium.Rectangle.equals(n._rectangle,i))return a.data.terrainData._childTileMask&1<<s}}return!0},SGSTerrainProvider.prototype.markTileAsUnavailable=function(e,r,t){var i=this._tilingScheme.tileXYToRectangle(e,r,t,new Cesium.Rectangle),a=this.findDirectParent(i);if(a&&a.data&&a.data.terrainData&&0<a.data.terrainData._childTileMask)for(var o=0;o<a.children.length;o++){var s=a.children[o];if(Cesium.Rectangle.equals(s._rectangle,i)){switch(o){case 0:a.data.terrainData._childTileMask&=-5;break;case 1:a.data.terrainData._childTileMask&=-9;break;case 2:a.data.terrainData._childTileMask&=-2;break;case 3:a.data.terrainData._childTileMask&=-3}return!1}return!0}},SGSTerrainProvider.prototype.requestBaseTerrainTileGeometry=function(e,r,t,i){return this.requestTileGeometryBuffers(e,r,t,i)},SGSTerrainProvider.prototype.requestElevationLayerTileGeometry=function(e,r,t,i,a){return this.requestTileGeometryBuffers(e,r,t,i,a)},SGSTerrainProvider.prototype.requestTileGeometryBuffers=function(e,r,t,i,a){var o,s,n,g=this,m={},l=(m.requestedRectangle=this.tilingScheme.tileXYToNativeRectangle(e,r,t),this.requestTileHeightBuffer(e,r,t,i,void 0,m.layer=a));if(void 0!==l)return o=this.requestTileHeightBuffer(e+1,r,t,i,!0,a),s=this.requestTileHeightBuffer(e,r+1,t,i,!0,a),n=this.requestTileHeightBuffer(e+1,r+1,t,i,!0,a),new Promise((c,f)=>{Promise.all([l,o,s,n]).then(e=>{if(0==debugFlatTerrain)if(null!=e[0].myReject&&e[0].myReject)f();else{for(var r=g.heightMapWidth+1,t=g.heightMapHeight+1,i=new Float32Array(r*t),a=e[0].isFloor,o=0;o<r;o++)for(var s=0;s<t;s++){var n=o,l=s,h=0,u=(s===r-1&&(l=0,h=1,a)&&(h=0,l=r-2),o===t-1&&(n=0,h=2),o*r+s),n=n*g.heightMapWidth+l;null===e[h]||null!=e[h].myReject&&e[h].myReject||(i[u]=e[h][n])}null!=e[3].myReject&&e[3].myReject||(i[r*t-1]=e[3][0]);var d=g.arrayToHeightmapTerrainData(i,r,t,15);m.buffer=d,c(m)}else{d=g.arrayToHeightmapTerrainData(e[0],g.heightMapWidth,g.heightMapHeight);m.buffer=d,c(m)}}).catch(()=>{f()})})},SGSTerrainProvider.prototype.requestTileGeometry=function(e,r,t,i){var o=this,s=[],a=o.tilingScheme.tileXYToNativeRectangle(e,r,t);if(null!=this._allElevationLayers&&0<this._allElevationLayers.length&&7<t)for(var n=0;n<this._allElevationLayers.length;n++){var l,h=this._allElevationLayers[n];h.show?(l=h.rectangle,o.isT_Inside_E(a,l)?s.push(o.requestElevationLayerTileGeometry(e,r,t,i,h)):(null!=o.isT_Intersects_E(a,l)&&s.push(o.requestElevationLayerTileGeometry(e,r,t,i,h)),s.push(o.requestBaseTerrainTileGeometry(e,r,t,i)))):s.push(o.requestBaseTerrainTileGeometry(e,r,t,i))}else s.push(o.requestBaseTerrainTileGeometry(e,r,t,i));return new Promise((i,a)=>{Promise.all(s).then(e=>{var r,t;1===e.length?(void 0!==e.layer&&console.log("missing scale and offset"),i(e[0].buffer)):1<e.length?(r=e.filter(function(e){return void 0!==e.layer}),t=e.filter(function(e){return void 0!==e.layer}),0===r.length?i(e[0].buffer):(e=r[r.length-1],r=t[t.length-1],t={tolerance:e.layer.nullTolerance,nullValueNumber:e.layer.nullValueNumber,verticesX:e.layer.polygonVerticesX,verticesY:e.layer.polygonVerticesY,scale:Cesium.defaultValue(e.layer.scale,1),offset:Cesium.defaultValue(e.layer.offset,0)},i(o.mergeBuffers(r.buffer,e.buffer,t,r.requestedRectangle)))):a()}).catch(function(){a()})})},SGSTerrainProvider.prototype.mergeBuffers=function(e,r,t,i){i.west;for(var a,o,s,n,l=t.scale,h=t.offset,u=void 0!==t.nullValueNumber&&void 0!==t.tolerance,d=(u&&(s=Cesium.defaultValue(t.nullValueNumber,0),n=Cesium.defaultValue(Number(t.tolerance),0)),new Float32Array(1089)),c=0;c<33;c++)for(a=0,0;a<33;a++,0)d[o=33*c+a]=u?!r._buffer[o]||r._buffer[o]>=s-n&&r._buffer[o]<=s+n?e._buffer[o]:r._buffer[o]*l+h:r._buffer[o]?r._buffer[o]*l+h:e._buffer[o];return this.arrayToHeightmapTerrainData(d,33,33,15)},SGSTerrainProvider.prototype.requestTileHeightBuffer=function(c,g,m,e,v,p){var _;if(!isNaN(c+g+m))return _=0==(e=Cesium.defined(e)&&!1!==e?e:new Cesium.Request({defer:!0})).defer,v=Cesium.defaultValue(_,!1),new Promise((h,e)=>{if(0==debugFlatTerrain){var r,f,t=void 0,i=void 0;if(void 0!==p?(p.getUrlFromSTag=function(e,r,t){return void 0===p.subdomains?p.url:p.subdomains[0]+"/SG"},r=this.getRequestElevationLayer(c,g,m).replace(this._options.url,p.getUrlFromSTag(c,g,m)+"/Elevation").replace(this._options.layers,p.name)):(r=this.getRequestBaseTerrainUrl(c,g,m,_||v),f=viewer.terrainProvider.tilingScheme.tileXYToRectangle(c,g,m),t=Promise.resolve("NoMerge"),i=new Promise((d,e)=>{var r=viewer.scene.primitives._primitives.filter(function(e){return e instanceof Cesium.Cesium3DTileset}),c=!1;r.forEach(function(e){if(!SGSProvider){var r=TerraExplorer.functions.getTEObjFromObj(e);if(e.ready&&e.show&&void 0!==e.rootFloorRectangle&&void 0!==Cesium.Rectangle.intersection(f,e.rootFloorRectangle)){for(var t=new Uint16Array(1024),i=f.west,a=(f.south,(f.east-f.west)/32),o=(f.north-f.south)/32,s=0;s<32;s++)for(var n=0;n<32;n++){var l=f.north-o*s-o/2,l=new Cesium.Cartographic(i+a*n+a/2,l),h=65535,u=e.getHRMTFP(e,l,!0);null!=u&&u.content&&u.content._model&&u.content._model.floor&&(h=u.content._model.floor.getHeight(l.longitude,l.latitude,u),h+=r.options.Altitude_pos-r.defaultPositionObj.Altitude_pos),65535!==h&&(h=h-e.origAltitude+e.realAltitude+1.5),t[32*s+n]=h}c=!0,d(t)}}}),c||d("NoFloor"),viewer.scene.globe.ellipsoid})),!1===this._requestsCache.hasOwnProperty(r)){if(this._requestsCache[r]={},this._requestsCacheKeys.push(r),100<this._requestsCacheKeys.length){for(var a=0;a<50;a++)delete this._requestsCache[this._requestsCacheKeys[a]];this._requestsCacheKeys.splice(0,50)}}else{var o=this._requestsCacheKeys.indexOf(r);this._requestsCacheKeys.splice(o,1),this._requestsCacheKeys.push(r)}var u,s=this._requestsCache[r];void 0===s.dataLoaded&&(_?void 0===Cesium.Resource?s.dataLoaded=Cesium.RequestScheduler.request(r,Cesium.loadArrayBuffer):s.dataLoaded=Cesium.Resource.fetchArrayBuffer(r):void 0===Cesium.Resource?s.dataLoaded=Cesium.loadArrayBuffer(r):s.dataLoaded=Cesium.Resource.fetchArrayBuffer(r),!Cesium.defined(s.dataLoaded))||((u=this)._pendingRequests++,s.dataLoaded.then(e=>{void 0===s.workerFinished&&(s.workerFinished=u._workerPool.queueWorkItem({buffer:e,isElevation:void 0!==p,level:m})),Promise.all([s.workerFinished,t,i]).then(e=>{var r=void 0!==e[1]&&"NoMerge"!==e[1],t=void 0!==e[2]&&"NoFloor"!==e[2];if(e[0].rejected){for(var i=u.heightMapWidth*u.heightMapHeight,a=new Int16Array(i),o=0;o<i;o++)a[o]=300;2<m&&(a.myReject=!0),h(a)}else{var s=u.extractTileHeightBuffer(e[0].buffer,c,g,m);if(u._pendingRequests--,r)for(var o=0;o<32;o++)for(var n=0;n<32;n++){var l=32*o+n;e[1].fromKML?s[l]=1===e[1][l]?s[l]:1==e[1].elevationBehavior?s[l]+e[1].mtHeight:2==e[1].elevationBehavior?Math.min(s[l],e[1].mtHeight):3==e[1].elevationBehavior?Math.max(s[l],e[1].mtHeight):e[1].mtHeight:s[l]=1===e[1][l]?s[l]:1==e[1].elevationBehavior?s[l]+e[1][l]:2==e[1].elevationBehavior?Math.min(s[l],e[1][l]):3==e[1].elevationBehavior?Math.max(s[l],e[1][l]):e[1][l]}if(t){for(o=0;o<32;o++)for(n=0;n<32;n++)s[l=32*o+n]=(65535===e[2][l]?s:e[2])[l];s.isFloor=!0}h(s)}}).catch(()=>{for(var e=u.heightMapWidth*u.heightMapHeight,r=new Int16Array(e),t=0;t<e;t++)r[t]=300;2<m&&(r.myReject=!0),h(r)})}).catch(()=>{u._pendingRequests--,e()}))}else{for(var n=this.heightMapWidth*this.heightMapHeight,l=new Int16Array(n),d=getRandomIntInclusive(0,1500),a=0;a<n;a++)l[a]=d;h(l)}})},SGSTerrainProvider.prototype.extractTileHeightBuffer=function(e,r,t,i){try{for(var a=this.requestFactorForLevel(i),o=r%a,s=t%a,n=new Int16Array(this.heightMapWidth*this.heightMapHeight),l=1e6,h=-1e5,u=0;u<this.heightMapHeight;u++)for(var d=0;d<this.heightMapWidth;d++){var c=u+s*this.heightMapHeight,f=d+o*this.heightMapWidth,g=u*this.heightMapWidth+d,m=c*this.heightMapWidth*a+f;e[m]>h&&(h=e[m]),e[m]<l&&(l=e[m]),n[g]=e[m]}}catch(e){console.log(e.message)}return n},SGSTerrainProvider.prototype.arrayToHeightmapTerrainData=function(e,r,t,i){return!1===Cesium.defined(e)&&(e=new Int16Array(r*t)),new Cesium.HeightmapTerrainData({buffer:e,width:r,height:t,childTileMask:i})};var WorkerPool=function(e){if(e=e||[],!Cesium.defined(e.workerPath))throw new Cesium.DeveloperError("workerPath is required.");this._workerPath=e.workerPath,this._poolSize=Cesium.defaultValue(e.poolSize,16),this._workers=[],this._defered=[]};function find(e,r){for(var t=0;t<e.length;t++)if(r(e[t]))return t}Object.defineProperties(WorkerPool.prototype,{errorEvent:{get:function(){return this.errorEvent}},poolSize:{get:function(){return this._poolSize}}}),WorkerPool.prototype.queueWorkItem=function(n,l){return new Promise((e,r)=>{for(var t,i=null,a=999999,o=0;o<this._workers.length;o++){i=this._workers[o];this._workers[o].jobQueueSize<a&&(i=this._workers[o],a=this._workers[o].jobQueueSize)}0<a&&this._workers.length<this.poolSize&&(i=new Worker(this._workerPath),t=this,i.addEventListener("message",function(e){t.onWorkerMessage(e)},!1),i.addEventListener("error",function(e){t.onWorkerError(e)},!1),i.jobQueueSize=0,this._workers.push(i),i.id=Cesium.createGuid()),n.workerId=i.id;var s=Cesium.createGuid();n.deferedId=s,this._defered[s]=e,i.jobQueueSize++,i.postMessage(n,l)})},WorkerPool.prototype.trimPool=function(e){var r=this;if(null==e)null!=this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(function(){r.trimPool(!0)},5e3);else{for(var t=0;t<this._workers.length;t++)0==this._workers[t].jobQueueSize&&(this._workers[t].terminate(),this._workers.splice(t,1),t--);this._workers.length?this.timerId=setTimeout(function(){r.trimPool(!0)},5e3):this.timerId=null}},WorkerPool.prototype.onWorkerMessage=function(e){var r=e.data,e=find(this._workers,function(e){return e.id===r.workerId}),e=(null!=e&&(this._workers[e].jobQueueSize--,this.trimPool()),this._defered[r.deferedId]);delete this._defered[r.deferedId],e(r)},WorkerPool.prototype.onWorkerError=function(e){console.log(e)};